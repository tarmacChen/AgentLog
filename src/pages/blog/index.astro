---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const readingTime = (body: string) => Math.max(1, Math.ceil(body.split(/\s+/).length / 200));

const featured = posts[0];
const rest = posts.slice(1);

const formatDate = (date: Date) =>
  date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
---

<BaseLayout title="Posts â€” AgentLog">
  <section>
    {posts.length === 0 ? (
      <p class="text-gray-400">No posts yet. Check back soon.</p>
    ) : (
      <>
        {/* Featured post */}
        <a href={`${base}/blog/${featured.id}/`} class="group block">
          {featured.data.heroImage && (
            <img
              src={`${base}${featured.data.heroImage}`}
              alt={featured.data.title}
              class="w-full aspect-video object-cover rounded-lg mb-4"
            />
          )}
          <time class="text-sm text-gray-400 uppercase tracking-wide">
            {formatDate(featured.data.pubDate)}
          </time>
          <h2 class="text-3xl sm:text-4xl font-bold mt-2 group-hover:text-blue-400 transition-colors leading-tight">
            {featured.data.title}
          </h2>
          <p class="text-gray-500 dark:text-gray-400 mt-3 text-lg leading-relaxed">
            {featured.data.description}
          </p>
          <div class="flex items-center gap-1.5 mt-3 text-sm text-gray-400">
            <span>{readingTime(featured.body ?? '')} min read</span>
            {featured.data.tags?.map((tag) => (
              <>
                <span>&middot;</span>
                <span>{tag}</span>
              </>
            ))}
          </div>
        </a>

        {/* Divider + grid for remaining posts */}
        {rest.length > 0 && (
          <>
            <hr class="my-8 sm:my-10 border-gray-200 dark:border-gray-700" />
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
              {rest.map((post) => (
                <a href={`${base}/blog/${post.id}/`} class="group block">
                  {post.data.heroImage && (
                    <img
                      src={`${base}${post.data.heroImage}`}
                      alt={post.data.title}
                      class="w-full aspect-video object-cover rounded-lg mb-3"
                    />
                  )}
                  <time class="text-sm text-gray-400 uppercase tracking-wide">
                    {formatDate(post.data.pubDate)}
                  </time>
                  <h3 class="text-xl font-semibold mt-1 group-hover:text-blue-400 transition-colors">
                    {post.data.title}
                  </h3>
                  <p class="text-gray-500 dark:text-gray-400 text-base mt-1 line-clamp-2">
                    {post.data.description}
                  </p>
                  <div class="flex items-center gap-1.5 mt-2 text-sm text-gray-400">
                    <span>{readingTime(post.body ?? '')} min read</span>
                    {post.data.tags?.map((tag) => (
                      <>
                        <span>&middot;</span>
                        <span>{tag}</span>
                      </>
                    ))}
                  </div>
                </a>
              ))}
            </div>
          </>
        )}
      </>
    )}
  </section>
</BaseLayout>
